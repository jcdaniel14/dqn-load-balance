from utils import send_error
import pandas as pd
import logging
import subprocess
import json
import sys

# === CONSTANTS
logger = logging.getLogger("health-monitor")
logger.setLevel(logging.INFO)


def get_df_gate(saturada):
    cmd = f"/home/gsantiago/go_2020/netflow/plot_points/plot_points --gate {saturada.gate} --subnet ALL"  # TODO produccion
    # logger.info(f"CMD: {cmd}")
    output = subprocess.run([cmd], stdout=subprocess.PIPE, shell=True).stdout.decode("utf-8")
    # print(output)
    # output = """{"status":"ok","response":[{"date":1612933200,"value":9101816000},{"date":1612934100,"value":7540265500},{"date":1612935000,"value":7143689000},{"date":1612935900,"value":6193711000},{"date":1612936800,"value":5524322300},{"date":1612937700,"value":5058770400},{"date":1612938600,"value":4247365000},{"date":1612939500,"value":3746982700},{"date":1612940400,"value":3385356000},{"date":1612941300,"value":3101833700},{"date":1612942200,"value":3092905000},{"date":1612943100,"value":2684044800},{"date":1612944000,"value":2816494300},{"date":1612944900,"value":2347837200},{"date":1612945800,"value":1989567900},{"date":1612946700,"value":1903499600},{"date":1612947600,"value":1846169300},{"date":1612948500,"value":1474500500},{"date":1612949400,"value":1480132500},{"date":1612950300,"value":1321031700},{"date":1612951200,"value":1145664800},{"date":1612952100,"value":1500026800},{"date":1612953000,"value":1489006100},{"date":1612953900,"value":1535513900},{"date":1612954800,"value":1624735200},{"date":1612955700,"value":1806343200},{"date":1612956600,"value":2019982800},{"date":1612957500,"value":2445475800},{"date":1612958400,"value":2796193000},{"date":1612959300,"value":3232803300},{"date":1612960200,"value":3736506600},{"date":1612961100,"value":4182344700},{"date":1612962000,"value":4714600000},{"date":1612962900,"value":5199109000},{"date":1612963800,"value":5534649000},{"date":1612964700,"value":5697503000},{"date":1612965600,"value":5892030000},{"date":1612966500,"value":6431940000},{"date":1612967400,"value":6629960700},{"date":1612968300,"value":6567094000},{"date":1612969200,"value":6448211500},{"date":1612970100,"value":7128557000},{"date":1612971000,"value":6967945000},{"date":1612971900,"value":6662372400},{"date":1612972800,"value":7218737000},{"date":1612973700,"value":7782667000},{"date":1612974600,"value":7506618400},{"date":1612975500,"value":7869534000},{"date":1612976400,"value":7723757000},{"date":1612977300,"value":7782234000},{"date":1612978200,"value":7950240300},{"date":1612979100,"value":8326711000},{"date":1612980000,"value":8233063400},{"date":1612980900,"value":8440279000},{"date":1612981800,"value":8386009600},{"date":1612982700,"value":8801628000},{"date":1612983600,"value":8344483300},{"date":1612984500,"value":8978481000},{"date":1612985400,"value":8790630000},{"date":1612986300,"value":9201033000},{"date":1612987200,"value":8449092000},{"date":1612988100,"value":8424504000},{"date":1612989000,"value":8630034000},{"date":1612989900,"value":8841577000},{"date":1612990800,"value":8533238000},{"date":1612991700,"value":8186076700},{"date":1612992600,"value":8332962300},{"date":1612993500,"value":8416899000},{"date":1612994400,"value":8545884000},{"date":1612995300,"value":8304287000},{"date":1612996200,"value":8177411000},{"date":1612997100,"value":8463082500},{"date":1612998000,"value":8585596000},{"date":1612998900,"value":8688637000},{"date":1612999800,"value":8233018000},{"date":1613000700,"value":8792568000},{"date":1613001600,"value":8779008000},{"date":1613002500,"value":8636566000},{"date":1613003400,"value":8487868000},{"date":1613004300,"value":8471762400},{"date":1613005200,"value":8110095000},{"date":1613006100,"value":8286298000},{"date":1613007000,"value":8605744000},{"date":1613007900,"value":9129202000},{"date":1613008800,"value":9216044000},{"date":1613009700,"value":9166942000},{"date":1613010600,"value":9950977000},{"date":1613011500,"value":9722310000},{"date":1613012400,"value":10188400000},{"date":1613013300,"value":10182472000},{"date":1613014200,"value":10867553000},{"date":1613015100,"value":10830885000},{"date":1613016000,"value":11084062000},{"date":1613016900,"value":10265726000},{"date":1613017800,"value":9794278000},{"date":1613018700,"value":9765533000},{"date":1613019600,"value":8355524000},{"date":1613020500,"value":8057435000},{"date":1613021400,"value":6765449000},{"date":1613022300,"value":6291958000},{"date":1613023200,"value":5793424000},{"date":1613024100,"value":4742977500},{"date":1613025000,"value":4394607000},{"date":1613025900,"value":3923469300},{"date":1613026800,"value":3608257500},{"date":1613027700,"value":3465263400},{"date":1613028600,"value":2763577900},{"date":1613029500,"value":2449308700},{"date":1613030400,"value":2203435300},{"date":1613031300,"value":1885946200},{"date":1613032200,"value":1680373600},{"date":1613033100,"value":1629386800},{"date":1613034000,"value":1504269600},{"date":1613034900,"value":1448090400},{"date":1613035800,"value":1609968500},{"date":1613036700,"value":1353024400},{"date":1613037600,"value":1301681200},{"date":1613038500,"value":1317571600},{"date":1613039400,"value":1441807000},{"date":1613040300,"value":1472603600},{"date":1613041200,"value":1714161800},{"date":1613042100,"value":1615518700},{"date":1613043000,"value":1745562600},{"date":1613043900,"value":2043823600},{"date":1613044800,"value":2369054000},{"date":1613045700,"value":2996072000},{"date":1613046600,"value":3073263000},{"date":1613047500,"value":3863122400},{"date":1613048400,"value":4553560000},{"date":1613049300,"value":5250468400},{"date":1613050200,"value":5432780300},{"date":1613051100,"value":5806440000},{"date":1613052000,"value":6026899500},{"date":1613052900,"value":6081711000},{"date":1613053800,"value":6571649000},{"date":1613054700,"value":6583481300},{"date":1613055600,"value":6795439000},{"date":1613056500,"value":7438913500},{"date":1613057400,"value":7658332000},{"date":1613058300,"value":7952159000},{"date":1613059200,"value":7344964000},{"date":1613060100,"value":7142388000},{"date":1613061000,"value":7448933400},{"date":1613061900,"value":7830489000},{"date":1613062800,"value":7487665700},{"date":1613063700,"value":7992620500},{"date":1613064600,"value":8203577000},{"date":1613065500,"value":8313741000},{"date":1613066400,"value":8368093700},{"date":1613067300,"value":8463209500},{"date":1613068200,"value":8240807000},{"date":1613069100,"value":8159392000},{"date":1613070000,"value":8628918000},{"date":1613070900,"value":9046704000},{"date":1613071800,"value":8971919000},{"date":1613072700,"value":8554460000},{"date":1613073600,"value":8277046000},{"date":1613074500,"value":9108002000},{"date":1613075400,"value":8996013000},{"date":1613076300,"value":9302966000},{"date":1613077200,"value":7006459400}]}"""
    if output.find("{") == -1:
        send_error("No se logro detectar el BW (Plot Points). Favor revisar en Go")

    rs = json.loads(output)['response']
    return rs


def get_df_subnets(mejores_subredes, saturada):
    subnet_agg = {}
    for s in mejores_subredes:
        cmd = f"/home/gsantiago/go_2020/netflow/plot_points/plot_points --gate {saturada.gate} --subnet {s['net']}"  # TODO produccion
        # logger.info(f"CMD: {cmd}")
        output = subprocess.run([cmd], stdout=subprocess.PIPE, shell=True).stdout.decode("utf-8")
        if output.find("{") == -1:
            send_error("No se logro detectar el BW (Plot Points). Favor revisar en Go")
        # print(output)
        # output = """{"status":"ok","response":[{"date":1612933200,"value":1608586900},{"date":1612934100,"value":1379077600},{"date":1612935000,"value":1268282200},{"date":1612935900,"value":1179792500},{"date":1612936800,"value":1058364700},{"date":1612937700,"value":1023902340},{"date":1612938600,"value":904903550},{"date":1612939500,"value":737128600},{"date":1612940400,"value":723327040},{"date":1612941300,"value":665798000},{"date":1612942200,"value":587040060},{"date":1612943100,"value":528109900},{"date":1612944000,"value":567009150},{"date":1612944900,"value":452527460},{"date":1612945800,"value":373447330},{"date":1612946700,"value":343202200},{"date":1612947600,"value":347025860},{"date":1612948500,"value":330592060},{"date":1612949400,"value":333206800},{"date":1612950300,"value":343342370},{"date":1612951200,"value":316728030},{"date":1612952100,"value":458743300},{"date":1612953000,"value":338322100},{"date":1612953900,"value":422868100},{"date":1612954800,"value":395606530},{"date":1612955700,"value":543331260},{"date":1612956600,"value":604811000},{"date":1612957500,"value":696327300},{"date":1612958400,"value":999986240},{"date":1612959300,"value":1235369300},{"date":1612960200,"value":1519589200},{"date":1612961100,"value":1740033400},{"date":1612962000,"value":2252804900},{"date":1612962900,"value":2482161200},{"date":1612963800,"value":2516977700},{"date":1612964700,"value":2548390400},{"date":1612965600,"value":2610805500},{"date":1612966500,"value":2826974000},{"date":1612967400,"value":2709191400},{"date":1612968300,"value":2488708600},{"date":1612969200,"value":2423782000},{"date":1612970100,"value":2731548000},{"date":1612971000,"value":3129668000},{"date":1612971900,"value":3074833000},{"date":1612972800,"value":3179169800},{"date":1612973700,"value":3678136600},{"date":1612974600,"value":3858891300},{"date":1612975500,"value":4004639200},{"date":1612976400,"value":3938168000},{"date":1612977300,"value":3729865500},{"date":1612978200,"value":4053039600},{"date":1612979100,"value":3986342000},{"date":1612980000,"value":3899257000},{"date":1612980900,"value":3455294000},{"date":1612981800,"value":3459999200},{"date":1612982700,"value":3776681700},{"date":1612983600,"value":3571885000},{"date":1612984500,"value":3819166200},{"date":1612985400,"value":3986156000},{"date":1612986300,"value":4188954400},{"date":1612987200,"value":3673351700},{"date":1612988100,"value":3545189600},{"date":1612989000,"value":4035245000},{"date":1612989900,"value":3920539000},{"date":1612990800,"value":3798804200},{"date":1612991700,"value":3861397200},{"date":1612992600,"value":3710948000},{"date":1612993500,"value":3565513000},{"date":1612994400,"value":3534882800},{"date":1612995300,"value":3547376600},{"date":1612996200,"value":3587439000},{"date":1612997100,"value":3346344000},{"date":1612998000,"value":3035911000},{"date":1612998900,"value":2903215400},{"date":1612999800,"value":3009076500},{"date":1613000700,"value":2814409500},{"date":1613001600,"value":2974347800},{"date":1613002500,"value":2881828900},{"date":1613003400,"value":2351820300},{"date":1613004300,"value":2892900600},{"date":1613005200,"value":3168991000},{"date":1613006100,"value":3456026400},{"date":1613007000,"value":3437862700},{"date":1613007900,"value":3331236900},{"date":1613008800,"value":3284623400},{"date":1613009700,"value":3022718000},{"date":1613010600,"value":3211260400},{"date":1613011500,"value":3439262000},{"date":1613012400,"value":3318036000},{"date":1613013300,"value":2932370000},{"date":1613014200,"value":2250708700},{"date":1613015100,"value":2160100900},{"date":1613016000,"value":2018500500},{"date":1613016900,"value":1979117300},{"date":1613017800,"value":1866308900},{"date":1613018700,"value":1706735100},{"date":1613019600,"value":1660246800},{"date":1613020500,"value":1535213700},{"date":1613021400,"value":1383392100},{"date":1613022300,"value":1224129200},{"date":1613023200,"value":982567360},{"date":1613024100,"value":1062109300},{"date":1613025000,"value":978634600},{"date":1613025900,"value":937904830},{"date":1613026800,"value":850756500},{"date":1613027700,"value":748189300},{"date":1613028600,"value":745618200},{"date":1613029500,"value":630325570},{"date":1613030400,"value":492522080},{"date":1613031300,"value":444566180},{"date":1613032200,"value":430931260},{"date":1613033100,"value":419669500},{"date":1613034000,"value":344754980},{"date":1613034900,"value":396708220},{"date":1613035800,"value":240758990},{"date":1613036700,"value":366602000},{"date":1613037600,"value":350515650},{"date":1613038500,"value":289935330},{"date":1613039400,"value":364335070},{"date":1613040300,"value":394379840},{"date":1613041200,"value":402129630},{"date":1613042100,"value":493917540},{"date":1613043000,"value":542176200},{"date":1613043900,"value":588813060},{"date":1613044800,"value":803622700},{"date":1613045700,"value":1070830600},{"date":1613046600,"value":1357970800},{"date":1613047500,"value":1516256100},{"date":1613048400,"value":2220951600},{"date":1613049300,"value":2260166700},{"date":1613050200,"value":2555569200},{"date":1613051100,"value":2478777900},{"date":1613052000,"value":2411724000},{"date":1613052900,"value":2595705000},{"date":1613053800,"value":2584113700},{"date":1613054700,"value":2516345000},{"date":1613055600,"value":2393670000},{"date":1613056500,"value":2517147600},{"date":1613057400,"value":2617959000},{"date":1613058300,"value":2510532900},{"date":1613059200,"value":2787000600},{"date":1613060100,"value":3135806700},{"date":1613061000,"value":3514618400},{"date":1613061900,"value":3767979000},{"date":1613062800,"value":3937813200},{"date":1613063700,"value":4025793300},{"date":1613064600,"value":4108761900},{"date":1613065500,"value":3799030300},{"date":1613066400,"value":3700649200},{"date":1613067300,"value":3512946400},{"date":1613068200,"value":3302515000},{"date":1613069100,"value":3095777000},{"date":1613070000,"value":3290852900},{"date":1613070900,"value":3304111600},{"date":1613071800,"value":3639855600},{"date":1613072700,"value":3366713900},{"date":1613073600,"value":3666497800},{"date":1613074500,"value":3847026200},{"date":1613075400,"value":4058581500},{"date":1613076300,"value":3939856000},{"date":1613077200,"value":3002276000}]}"""
        rs = output_to_dict(output)
        if len(rs) > 0:
            if len(subnet_agg) == 0:
                # logger.info("Primera asignacion de red")
                subnet_agg = rs
            else:
                # logger.info("Siguiente asignacion de red")
                subnet_agg = add_to_dict(subnet_agg, rs)
        else:
            logger.info("No existen valores de BW para esta subred.")
    return output_to_list(subnet_agg)


def output_to_dict(output):
    output = output[output.find("{"):].strip().strip("\n")
    rs = json.loads(output)['response']
    if rs:
        d = {}
        for item in rs:
            d[item['date']] = item['value']
        return d
    else:
        return {}


def add_to_dict(subnet_agg, rs):
    for epoch, value in rs.items():
        if epoch in subnet_agg:
            subnet_agg[epoch] += value
    return subnet_agg


def output_to_list(items):
    my_list = []
    for epoch, value in items.items():
        my_list.append({'date': epoch, 'value': value})
    return my_list
